## 文件上传下载

### 1.图片上传
图片上传的模型字段
ImageField: 上传图片
FileField: 上传文件(不限文件类型)

**a** 模型类代码
app/models.py

```python
from django.db import models

class ImageModel(models.Model):
    """文件上传"""

    # 用于保存文件
    # file = models.IntegerField()

    # 用于保存图片
    path = models.ImageField()

    def __str__(self):
        return self.path

    class Meta:
        db_table = "Images"
        verbose_name = "图片"
        verbose_name_plural = verbose_name
```

**b** 序列化器代码

```python
from rest_framework import serializers

from app.models import UserInfo, Addr, ImageModel

class ImageSerializer(serializers.ModelSerializer):
    """图片管理序列化器"""
    
    class Meta:
        model = ImageModel
        fields = '__all__'
```

**c** 视图类代码

```python
from rest_framework.viewsets import ModelViewSet
from app.serializers import UserInfoSerializer, AddrSerializer, ImageSerializer
from app.models import UserInfo, Addr, ImageModel

class ImageView(ModelViewSet):
    queryset = ImageModel.objects.all()
    serializer_class = ImageSerializer
```

**d** 路由配置

```python

from django.urls import path, include, re_path

from app.views import UserModelViewSet, AddrModelViewSet, ImageView

#导入路由库
from rest_framework import routers

#创建简单路由
router = routers.SimpleRouter()
router.register(r'users', UserModelViewSet)
router.register(r'addrs', AddrModelViewSet)
router.register(r'uploads', ImageView)

urlpatterns = [

]

#拼接路由
urlpatterns += router.urls

print(router.urls)
```

**e** 配置文件存储位置 
settings.py

```python
import os.path
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# 指定文件上传存放的路径:方式1
# MEDIA_ROOT = BASE_DIR / 'file' / 'image'
#指定文件上传存放的路径:方式2
MEDIA_ROOT = os.path.join(BASE_DIR,'file','image')
#指定文件的url路径
MEDIA_URL = '/media/'
```

**f** 生成对应表
```bash
python manage.py makemigrations

python manage.py migrate
```

直接使用DRF视图集里的方法实现
优点:代码少
缺点:无法添加限制

### 2.自定义图片上传

自定义图片上传视图
```python
from app.models import UserInfo, Addr, ImageModel
from app.serializers import UserInfoSerializer, AddrSerializer, ImageSerializer
from rest_framework.response import Response
from rest_framework import filters, status



from rest_framework.viewsets import mixins,GenericViewSet
class ImageView(mixins.CreateModelMixin, mixins.RetrieveModelMixin, mixins.ListModelMixin, GenericViewSet):

    queryset = ImageModel.objects.all()
    serializer_class = ImageSerializer

    def create(self, request, *args, **kwargs):
        """自定义图片上传功能"""
        image = request.data.get('path')
        # 获取图片名称
        name = image.name
        # 获取图片大小
        size = image.size
        # 获取图片类型
        type = image.content_type

        # 设置图片上传大小能起过30k
        if size > 1024 * 30000:
            max_size = {
                'error': "图片大小不能超过30k"
            }
            return Response(max_size, status=status.HTTP_400_BAD_REQUEST)
        elif type not in ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp']:
            type_error = {
                'error': f"图片类型不正确{type}"
            }
            return Response(type_error, status=status.HTTP_400_BAD_REQUEST)
        else:
            return super().create(request, *args, **kwargs)

```


